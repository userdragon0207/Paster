name: Build Paster (Windows ä¾¿æºç‰ˆ)

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]

jobs:
  build-windows:
    runs-on: windows-latest
    timeout-minutes: 45

    steps:
      # 1. æ‹‰å–ä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. å®‰è£…Node.js
      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: ''  # ç¦ç”¨è‡ªåŠ¨ç¼“å­˜ï¼Œé¿å…è·¯å¾„å†²çª

      # 3. é…ç½®npmå…¨å±€è·¯å¾„ï¼ˆè§£å†³pnpmè·¯å¾„é—®é¢˜ï¼‰
      - name: Get npm global prefix
        id: npm-config
        run: |
          $npmPrefix = (npm prefix -g).Trim()
          Write-Host "npm global prefix: $npmPrefix"
          echo "$npmPrefix" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          echo "npmPrefix=$npmPrefix" >> $env:GITHUB_OUTPUT
        shell: pwsh

      # 4. å®‰è£…pnpmå¹¶éªŒè¯è·¯å¾„
      - name: Install and verify pnpm
        id: pnpm-install
        run: |
          npm install -g pnpm@8.15.6
          $pnpmExePath = Join-Path -Path "${{ steps.npm-config.outputs.npmPrefix }}" -ChildPath "pnpm.cmd"
          Write-Host "Checking pnpm path: $pnpmExePath"
          if (Test-Path $pnpmExePath) {
            Write-Host "pnpm installed successfully"
            echo "pnpmExePath=$pnpmExePath" >> $env:GITHUB_OUTPUT
          } else {
            Write-Error "pnpm not found at $pnpmExePath"
            Get-ChildItem -Path "${{ steps.npm-config.outputs.npmPrefix }}" | Format-Table
            exit 1
          }
        shell: pwsh

      # 5. éªŒè¯pnpmå¯ç”¨æ€§
      - name: Verify pnpm version
        run: |
          "${{ steps.pnpm-install.outputs.pnpmExePath }}" --version
        shell: cmd

      # 6. æ£€æŸ¥é”æ–‡ä»¶
      - name: Check for pnpm-lock.yaml
        run: |
          if not exist "pnpm-lock.yaml" (
            echo "Error: pnpm-lock.yaml not found"
            exit 1
          ) else (
            echo "pnpm-lock.yaml found"
          )
        shell: cmd

      # 7. å®‰è£…å‰ç«¯ä¾èµ–
      - name: Install frontend dependencies
        run: |
          "${{ steps.pnpm-install.outputs.pnpmExePath }}" install --frozen-lockfile
        shell: cmd

      # 8. æ„å»ºå‰ç«¯ä»£ç 
      - name: Build frontend
        run: |
          "${{ steps.pnpm-install.outputs.pnpmExePath }}" build
        env:
          NODE_ENV: production
        shell: cmd

      # ğŸ‘‡ åœ¨æ­¤å¤„æ’å…¥æ¸…ç†ç¼“å­˜æ­¥éª¤
      - name: Clean build cache
        run: |
          cd src-tauri && cargo clean  # æ¸…ç† Rust ç¼–è¯‘ç¼“å­˜
          rm -rf ../dist  # æ¸…ç†å‰ç«¯æ„å»ºäº§ç‰©ï¼ˆç¡®ä¿ä¸å®é™…äº§ç‰©ç›®å½•ä¸€è‡´ï¼‰
        shell: bash  # ä½¿ç”¨ bash æ‰§è¡Œè·¨å¹³å°å‘½ä»¤
      
      # 9. å®‰è£…å…¼å®¹ç‰ˆæœ¬çš„Rust
      - name: Install Rust 1.75.0
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.75.0
          cache: true
          cache-key: 'rust-cache-${{ hashFiles(''src-tauri/Cargo.lock'') }}'

      # 10. å®‰è£…å…¼å®¹ç‰ˆæœ¬çš„Tauri CLI
      - name: Install Tauri CLI 1.5.6
        run: |
          cargo install tauri-cli --version 1.5.6 --locked

      # 11. å®‰è£…WebView2è¿è¡Œæ—¶ï¼ˆWindowså¿…éœ€ï¼‰
      - name: Install WebView2 runtime
        run: |
          Invoke-WebRequest -Uri https://go.microsoft.com/fwlink/p/?LinkId=2124703 -OutFile webview2-installer.exe
          .\webview2-installer.exe /silent /install
        shell: pwsh

      # 12. æ„å»ºTauriä¾¿æºç‰ˆåº”ç”¨
      - name: Build Tauri portable app
        run: cargo tauri build
        working-directory: ./src-tauri
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 13. éªŒè¯ä¾¿æºç‰ˆäº§ç‰©
      - name: Verify portable build output
        id: verify-build
        run: |
          # ä¾¿æºç‰ˆEXEç›´æ¥ç”Ÿæˆåœ¨target/releaseç›®å½•
          $exePath = Get-ChildItem -Path ./src-tauri/target/release -Filter *.exe -Recurse | Select-Object -First 1
          if (-not $exePath) {
            Write-Error "No portable EXE file found"
            exit 1
          }
          Write-Host "Found portable executable: $($exePath.FullName)"
          echo "exePath=$($exePath.FullName)" >> $env:GITHUB_OUTPUT
        shell: pwsh

      # 14. ä¸Šä¼ ä¾¿æºç‰ˆäº§ç‰©
      - name: Upload portable artifact
        uses: actions/upload-artifact@v4
        with:
          name: paster-windows-portable-v${{ github.ref_name }}
          path: ${{ steps.verify-build.outputs.exePath }}
          retention-days: 14


